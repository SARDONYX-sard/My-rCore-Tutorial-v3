name: CI

on:
  push:
    branches:
      - "*"
    tags:
      - "*"
  pull_request:
  workflow_dispatch:

jobs:
  parameters:
    name: Set parameters
    runs-on: ubuntu-latest
    outputs:
      TOOL_CHAIN: nightly-2022-08-28
    steps:
      - id: SET_PARAMS
        run: |
          echo "::set-output name=TOOL_CHAIN::$TOOL_CHAIN"

  setup:
    name: Setup
    needs: parameters
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v2

      - name: Cache rust-toolchain
        if: github.event_name != 'schedule'
        uses: actions/cache@v3
        with:
          path: |
            ~/.rustup/settings.toml
            ~/.rustup/toolchains
            ~/.rustup/update-hashes
          key: toolchain-${{ needs.parameters.outputs.TOOL_CHAIN }}
      - name: Install Rust Toolchain
        uses: actions-rs/toolchain@v1
        with:
          toolchain: ${{ needs.parameters.outputs.TOOL_CHAIN }}
          target: riscv64gc-unknown-none-elf
          profile: minimal
          components: rust-src, llvm-tools-preview

  formatting:
    name: Formatting
    runs-on: ubuntu-latest
    needs: ["parameters", "setup"]
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v2

      - name: Restore cache rust-toolchain
        if: github.event_name != 'schedule'
        uses: actions/cache@v3
        with:
          path: |
            ~/.rustup/settings.toml
            ~/.rustup/toolchains
            ~/.rustup/update-hashes
          key: toolchain-${{ needs.parameters.outputs.TOOL_CHAIN }}

      - name: Check formatting
        run: make fmt-check

  build:
    name: Build
    needs: ["parameters", "setup"]
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v2

      - name: Cache cargo dependencies
        uses: Swatinem/rust-cache@v2
        with:
          shared-key: ${{ runner.os }}-cargo-${{ hashFiles('**/Cargo.lock') }}
      - name: Install dependencies
        run: cd os && cargo build && cd - && cd user && cargo build

  lint:
    name: Check
    runs-on: ubuntu-latest
    needs: ["parameters", "setup", "build"]
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v2

      - name: Restore cache rust-toolchain
        if: github.event_name != 'schedule'
        uses: actions/cache@v3
        with:
          path: |
            ~/.rustup/settings.toml
            ~/.rustup/toolchains
            ~/.rustup/update-hashes
          key: toolchain-${{ needs.parameters.outputs.TOOL_CHAIN }}

      - name: Cache cargo dependencies
        uses: Swatinem/rust-cache@v2
        with:
          shared-key: ${{ runner.os }}-cargo-${{ hashFiles('**/Cargo.lock') }}
      - name: Run `cargo check`
        run: make check

  test:
    name: Test
    strategy:
      fail-fast: false
      matrix:
        platform: [ubuntu-latest]
    runs-on: ${{ matrix.platform }}
    needs: ["parameters", "setup", "build"]
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v2

      - name: Cache QEMU
        uses: actions/cache@v3
        with:
          path: qemu-7.0.0
          key: qemu-7.0.0-x86_64-riscv64
      - name: Install QEMU
        run: |
          sudo apt-get update
          sudo apt-get install ninja-build -y
          if [ ! -d qemu-7.0.0 ]; then
            wget https://download.qemu.org/qemu-7.0.0.tar.xz
            tar -xf qemu-7.0.0.tar.xz
            cd qemu-7.0.0
            ./configure --target-list=riscv64-softmmu
            make -j
          else
            cd qemu-7.0.0
          fi
          sudo make install
          qemu-system-riscv64 --version

      - name: Restore cache rust-toolchain
        if: github.event_name != 'schedule'
        uses: actions/cache@v3
        with:
          path: |
            ~/.rustup/settings.toml
            ~/.rustup/toolchains
            ~/.rustup/update-hashes
          key: toolchain-${{ needs.parameters.outputs.TOOL_CHAIN }}

      - name: Cache cargo-binutils
        uses: actions/cache@v3
        with:
          path: ~/.cargo/bin
          key: cargo-0.3.6
      # os.bin cannot be started if it contains metadata
      # Need objcopy to erase metadata
      - name: Install cargo-binutils
        run: cargo install cargo-binutils --version 0.3.6

      - name: Restore cargo dependencies
        uses: Swatinem/rust-cache@v2
        with:
          shared-key: ${{ runner.os }}-cargo-${{ hashFiles('**/Cargo.lock') }}
      - name: Run test
        run: cd ./os && make run TEST=1
        timeout-minutes: 10

  clippy:
    name: Clippy
    runs-on: ubuntu-latest
    needs: ["parameters", "setup", "build"]
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v2

      - name: Restore cache rust-toolchain
        if: github.event_name != 'schedule'
        uses: actions/cache@v3
        with:
          path: |
            ~/.rustup/settings.toml
            ~/.rustup/toolchains
            ~/.rustup/update-hashes
          key: toolchain-${{ needs.parameters.outputs.TOOL_CHAIN }}

      - name: Restore cargo dependencies
        uses: Swatinem/rust-cache@v2
        with:
          shared-key: ${{ runner.os }}-cargo-${{ hashFiles('**/Cargo.lock') }}
      - name: Run `cargo clippy`
        run: make clippy
